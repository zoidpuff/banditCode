---
title: "Bandit Archetypal Analysis"
output: github_document
---

Read in the data and store it as a data frame

```{r setup, include=FALSE}

library(rhdf5)
library(tidyverse)
library(ggplot2)
library(archetypes)

```


```{r helper functions}
# Load helper functions
source("banditAnalysis.r")


plotTernaryWithArrows <- function(alphasThree, Grouplabels, mappingVec,FilterVec,zoom,colVar){
    # Create a vector which contains the opposite state for each state
    experimentalGroupings <- paste0(Grouplabels$Mouse,
                                    mappingVec[as.character(Grouplabels$State)])
    
    filtInds <- which(mappingVec[as.character(Grouplabels$State)] %in% FilterVec)
    varNames <- colnames(alphasThree)

    p <- ggtern::ggtern(data = alphasThree[filtInds,],
                aes_string(x = varNames[1], y = varNames[2], z = varNames[3],
                            color = paste0("as.character(collapsedSecondHalfincl$",colVar,")[filtInds]"),
                            group = "experimentalGroupings[filtInds]")) + 
                geom_point(size=3) + 
                geom_line(arrow = arrow(length=unit(0.3,"cm"),
                            ends="both", type = "open"),
                            color = "#000000",
                            alpha=0.2) +
                ggtern::theme_rgbw() +
                guides(color = guide_legend(title = colVar)) +
                labs(x = varNames[1], y = varNames[2], z = varNames[3],) + 
                ggtern::theme_zoom_center(x = zoom)
    return(p)
  }



```

```{r read data}
# Set the path to the hdf5 file
datafile <- '/home/gummi/banditExperiment/dataset.data'

# Load the hdf5 file
data <- h5dump(datafile,load=TRUE)

# Compute experiment stats
experimentData <- tabulateExperiments(data,datafile,2)

TesmerFeatures <- c("ProbOfChoosing_0.25",
                  "ProbOfChoosing_0.5",
                  "ProbOfChoosing_1",
                  "banditChoiceProb_0.25>1",
                  "banditChoiceProb_1>0.5",
                  "banditChoiceProb_0.5>1",
                  "ProbOfCircle")


```

```{r prepare Data frame}
collapsedSecondHalf <- experimentData[["SplitProbExperiments"]][["Split_1050_1800"]] %>% 
                        averageReplicates() %>%
                        select(all_of(TesmerFeatures))
                        # Sort dataframe so that the states are in the same order
                        %>% arrange(State)	

collapsedSecondHalfTrials <- experimentData[["SplitProbExperiments"]][["Split_1050_1800"]] %>% 
                        averageReplicates() %>%
                        select(all_of(c(TesmerFeatures,"numberOfTrials"))) 


collapsedSecondHalfincl <- experimentData[["SplitProbExperiments"]][["Split_1050_1800"]] %>% 
                        averageReplicates()
```

Do iterative archetypal analysis with the arhcetypal R package

```{r try Archetypal Analysis}

arhcetypal <- stepArchetypes(data = collapsedSecondHalfTrials, 
                         k = 1:10, 
                         minImprovement = 0.000001,
                         verbose = TRUE,
                         nrep = 50)

bestArchetypes <- bestModel(arhcetypal)
#pheatmap::pheatmap(rss(arhcetypal),
#                    cluster_rows = FALSE,
#                    cluster_cols = FALSE)

# Plot the scree plot of the archetypal analysis (RSS as a function of number of archetypes)
screeplot(arhcetypal)

```


```{r plot Archetypal Analysis}


ternPlotData <- as.data.frame(coef(bestArchetypes[[3]],'alphas'))
colnames(ternPlotData) <- c("One","Two","Three")

plotTernaryWithArrows(ternPlotData, collapsedSecondHalfincl, mappingStateThing, c("Plain"),1.1,"State")
plotTernaryWithArrows(ternPlotData, collapsedSecondHalfincl, mappingStateThing, c("Plain","Drugs"),1.1,"Mouse")
plotTernaryWithArrows(ternPlotData, collapsedSecondHalfincl, mappingStateThing, c("Drugs"),1.1)

# Print the archetypes to console
t(parameters(bestArchetypes[[3]]))

# Plot the archetypes as barplots
barplot(bestArchetypes[[3]], collapsedSecondHalfTrials, percentiles = TRUE)


```



# Create a function for doing archetypal Analysis with predefined archetypes

```{r try Archetypal Analysis with predefined archetypes}


archtypesGridSearch <- function(archeMat, resolution = 1000, data,mouseData) {
  
    tarcheMat <- t(archeMat)
    alphas <- matrix(0,nrow = ncol(tarcheMat), ncol = nrow(data))

    heatPlots <- list()

    matrixList <- list()
    for(i in seq(0, 1, by = resolution)) {
        if(i == 1) {j_seq <- c(0)} else {
            j_seq <- round(seq(0, 1-i, by = resolution), 7)
        }
        k_seq <- round((1 - i - j_seq), 7)
        matrixList[[as.character(i)]] <- matrix(c(rep(i,length(j_seq)), j_seq, k_seq), ncol = 3)
    }
    allcombs <- do.call(rbind, matrixList)

    for(d in 1:nrow(data) ){
        print(d)
        dataPoint <-  data[d,]
        Aprox <-  tarcheMat %*% t(allcombs)
        ers <- colSums((sweep(Aprox, 1, t(dataPoint), "-"))^2)
        minError <- min(ers)
        currBest <- allcombs[which.min(ers),]
        alphas[,d] <- currBest
        
        heatmapPrim <- cbind(allcombs[,1:2],ers)
        colnames(heatmapPrim) <- c("Circle","GO","Error")
        heatmapPrim <- as.data.frame(heatmapPrim)
        # Use pivot_wider to make the data frame wide
        #heatmapPrimWide <- heatmapPrim %>% 
         #                   as.data.frame() %>%
          #              pivot_wider(names_from = c("Circle"), values_from = "Error")


        
        heatPlots[[d]] <- ggplot(heatmapPrim,aes(x = Circle, y = GO, fill = Error)) +
                            geom_tile() + 
                            scale_fill_gradient(low = "#075AFF", high = "#FF0000") +
                            scale_x_continuous(breaks = NULL) +
                            scale_y_continuous(breaks = NULL) + 
                            theme_classic() +
                            coord_fixed() +
                            ggtitle(paste0("RMSE landscape for mouse: ",mouseData$Mouse[d], " ", mouseData$State[d]),
                                subtitle = paste0("Minimum RMSE: ",round(minError,4))) +
                            annotate("point", x = currBest[1], y = currBest[2], size = 7, color = "#000000",shape = "x") + 
                            ylab("GO-Uncertainty") 


    }
    return(list(alphas,heatPlots))
}


```


```{r try Archetypal Analysis with predefined archetypes}
#"ProbOfChoosing_0.25","ProbOfChoosing_0.5","ProbOfChoosing_1","banditChoiceProb_0.25>1","banditChoiceProb_1>0.5","banditChoiceProb_0.5>1",","ProbOfCircle
archMat <- matrix(c(1/3, 1/3, 1/3, 0.5, 0.5, 0.5, 1,
    	            0,   0.5, 0.5, 1,   1,   1,   0,
                    0.5, 0.5, 0,   0,   0,   0,   0), nrow = 3,
                                                     ncol = 7, 
                                                     byrow = TRUE,
                                                    dimnames = list( c("Circle","GO","Uncertainty"),
                                                    TesmerFeatures))           


archeTypes <- archtypesGridSearch(archMat,0.001,collapsedSecondHalf,collapsedSecondHalfincl)

#fedFasted <- which(collapsedSecondHalfincl$State == "Fasted" | collapsedSecondHalfincl$State == "Fed")
#fedFastedVehicle <- which(collapsedSecondHalfincl$State == "FastedVeh" | collapsedSecondHalfincl$State == "FastedAlm")
#fastedFastedVehicle <- which(collapsedSecondHalfincl$State == "FastedVeh" | collapsedSecondHalfincl$State == "Fasted")


    
```

```{r plot Archetypal Analysis with predefined archetypes}

alphas <- as.data.frame(t(archeTypes[[1]]))
colnames(alphas) <- c("Circle","GO","Uncertainty")
# Create a vector whic contains the oppiite state for each state
mappingStateThing <- c("FastedVeh" = "Drugs",
                    "Fasted" = "Plain",
                    "Fed" = "Plain",
                    "FastedAlm" = "Drugs")



# Save the plot as a pdf wit cowplot
#cowplot::ggsave("ArchetypalAnalysis.pdf", width = 10, height = 10, units = "cm")
#cowplot::plot_grid(plotlist = archeTypes[[2]], ncol = 4)

plotTernaryWithArrows(alphas, collapsedSecondHalfincl, mappingStateThing, c("Plain"),1.1,"State")	
plotTernaryWithArrows(alphas, collapsedSecondHalfincl, mappingStateThing, c("Drugs"),1.1,"State")

plotTernaryWithArrows(alphas, collapsedSecondHalfincl, mappingStateThing, c("Drugs","Plain"),1,"Mouse")



```

```
